<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bo DB Admin</title>
  <style>
    :root { --bg: #1a1b1e; --card: #25262b; --border: #373a40; --text: #e8e8e8; --muted: #909296; --accent: #4dabf7; --danger: #ff6b6b; --fk: #69db7c; }
    * { box-sizing: border-box; }
    body { font-family: ui-monospace, "Cascadia Code", monospace; background: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.5; display: flex; min-height: 100vh; font-size: 13px; }
    h1 { font-size: 1rem; margin: 0 0 1rem; color: var(--accent); }
    .sidebar { width: 200px; min-width: 200px; background: var(--card); border-right: 1px solid var(--border); padding: 0.75rem; overflow-y: auto; }
    .sidebar-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 0.5rem; }
    .table-list { list-style: none; padding: 0; margin: 0; }
    .table-list li { margin: 0.125rem 0; }
    .table-list a { display: block; padding: 0.4rem 0.6rem; border-radius: 4px; color: var(--text); text-decoration: none; cursor: pointer; }
    .table-list a:hover { background: #2c2e33; }
    .table-list a.active { background: var(--accent); color: var(--bg); }
    .main { flex: 1; padding: 1rem; overflow: auto; min-width: 0; display: flex; flex-direction: column; }
    .query-section { margin-bottom: 1rem; }
    .query-editor { width: 100%; min-height: 80px; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.6rem; border-radius: 4px; font-family: inherit; font-size: 12px; resize: vertical; }
    .query-editor:focus { outline: none; border-color: var(--accent); }
    .query-actions { margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    button.primary { background: var(--accent); color: var(--bg); border: none; padding: 0.4rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 12px; }
    button.primary:hover { filter: brightness(1.1); }
    .msg { padding: 0.4rem 0.6rem; border-radius: 4px; font-size: 12px; }
    .msg.ok { background: rgba(77, 171, 247, 0.2); color: var(--accent); }
    .msg.err { background: rgba(255, 107, 107, 0.2); color: var(--danger); }
    .result-wrap { flex: 1; overflow: auto; }
    table.data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .data-table th, .data-table td { text-align: left; padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--border); white-space: pre-wrap; word-break: break-word; vertical-align: top; }
    .data-table th { color: var(--muted); font-weight: 500; position: sticky; top: 0; background: var(--card); }
    .data-table td.fk { color: var(--fk); cursor: pointer; text-decoration: underline; }
    .data-table td.fk:hover { filter: brightness(1.2); }
    .empty { color: var(--muted); font-style: italic; }
    .row-detail { margin-top: 1rem; padding: 1rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; }
    .row-detail h3 { font-size: 0.9rem; margin: 0 0 0.5rem; color: var(--muted); }
    .row-detail pre { margin: 0; font-size: 11px; white-space: pre-wrap; word-break: break-all; }
    .breadcrumb { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; }
    .breadcrumb strong { color: var(--text); }
    button.danger { background: var(--danger); color: #fff; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 11px; }
    button.danger:hover { filter: brightness(1.1); }
    .table-actions { margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; max-width: 90vw; max-height: 85vh; overflow: auto; }
    .modal h3 { margin: 0 0 1rem; color: var(--accent); }
    .modal .form-row { margin-bottom: 0.5rem; }
    .modal .form-row label { display: inline-block; min-width: 120px; color: var(--muted); font-size: 12px; }
    .modal .form-row input, .modal .form-row textarea { width: 100%; max-width: 400px; }
    .modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
    .data-table td.text-cell { color: var(--accent); cursor: pointer; text-decoration: underline; max-width: 200px; }
    .data-table td.text-cell:hover { filter: brightness(1.2); }
    .cell-content-modal .modal { max-width: 95vw; max-height: 90vh; padding: 1.25rem; }
    .cell-content-modal pre {
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 70vh;
      overflow: auto;
      font-size: 12px;
      line-height: 1.5;
      margin: 0;
      padding: 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>Bo DB</h1>
    <div class="sidebar-title">Tables</div>
    <ul class="table-list" id="table-list"></ul>
  </aside>
  <main class="main">
    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="query-section" class="query-section" style="display:none;">
      <textarea id="query-editor" class="query-editor" placeholder="SELECT * FROM ..."></textarea>
      <div class="query-actions">
        <button class="primary" id="run-query">Run</button>
        <button class="primary" id="reset-query">Reset</button>
        <span id="query-msg"></span>
      </div>
    </div>
    <div class="result-wrap">
      <div class="table-actions" id="table-actions" style="display:none;">
        <button class="primary" id="new-row-btn">New row</button>
      </div>
      <table class="data-table" id="result-table" style="display:none;">
        <thead id="result-thead"></thead>
        <tbody id="result-tbody"></tbody>
      </table>
      <div id="empty-state" class="empty" style="padding: 2rem;">Select a table or run a query.</div>
    </div>
    <div id="row-detail" class="row-detail" style="display:none;">
      <h3 id="row-detail-title"></h3>
      <pre id="row-detail-body"></pre>
    </div>

    <div id="row-modal" class="modal-overlay">
      <div class="modal">
        <h3 id="row-modal-title">Row</h3>
        <div id="row-modal-fields"></div>
        <div class="modal-actions">
          <button class="primary" id="row-modal-save">Save</button>
          <button id="row-modal-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <div id="cell-content-modal" class="modal-overlay cell-content-modal">
      <div class="modal">
        <h3 id="cell-content-title"></h3>
        <pre id="cell-content-body"></pre>
        <div class="modal-actions">
          <button id="cell-content-close">Close</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API = "";
    function escapeHtml(s) { const d = document.createElement("div"); d.textContent = s ?? ""; return d.innerHTML; }

    function prettifyForDisplay(s) {
      if (!s) return "";
      return String(s)
        .replace(/\\n/g, "\n")
        .replace(/\\t/g, "\t")
        .replace(/\\r/g, "\r");
    }

    /** Format UTC ISO string as MM/DD/YY HH:MM AM/PM in America/New_York (ET). */
    function formatUtcToEt(val) {
      if (val === null || val === undefined || val === "") return "";
      const d = new Date(val);
      if (isNaN(d.getTime())) return String(val);
      const fmt = new Intl.DateTimeFormat("en-US", { timeZone: "America/New_York", month: "2-digit", day: "2-digit", year: "2-digit", hour: "numeric", minute: "2-digit", hour12: true });
      const parts = fmt.formatToParts(d);
      const get = (type) => parts.find(p => p.type === type)?.value ?? "";
      const month = get("month");
      const day = get("day");
      const year = get("year");
      let hour = get("hour");
      const minute = get("minute");
      const dayPeriod = get("dayPeriod").toUpperCase();
      if (hour.length === 1) hour = "0" + hour;
      return `${month}/${day}/${year} ${hour}:${minute} ${dayPeriod}`;
    }

    async function api(method, path, body) {
      const opt = { method, headers: body ? { "Content-Type": "application/json" } : {} };
      if (body) opt.body = JSON.stringify(body);
      const r = await fetch(API + path, opt);
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || r.statusText);
      return j;
    }

    function showMsg(elId, text, isErr) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.textContent = text || "";
      el.className = "msg " + (text ? (isErr ? "err" : "ok") : "");
    }

    let tables = [];
    let selectedTable = null;
    let schema = { columns: [], foreignKeys: [] };
    let lastQuery = "";
    let lastResult = { columns: [], rows: [] };

    async function loadTables() {
      const ul = document.getElementById("table-list");
      ul.innerHTML = "<li class='empty'>Loading…</li>";
      try {
        const j = await api("GET", "/api/db/tables");
        tables = Array.isArray(j.tables) ? j.tables : [];
        if (tables.length === 0) {
          ul.innerHTML = "<li class='empty'>No tables</li>";
          return;
        }
        ul.innerHTML = tables.map(t => `<li><a href="#" data-table="${escapeHtml(t)}">${escapeHtml(t)}</a></li>`).join("");
        ul.querySelectorAll("a").forEach(a => {
          a.addEventListener("click", (e) => { e.preventDefault(); selectTable(a.dataset.table); });
        });
      } catch (e) {
        ul.innerHTML = "<li class='empty' style='color:var(--danger)'>Error: " + escapeHtml(e.message) + ". Open this page at http://localhost:" + (location.port || "3847") + "</li>";
      }
    }

    async function selectTable(table) {
      selectedTable = table;
      document.querySelectorAll(".table-list a").forEach(a => { a.classList.toggle("active", a.dataset.table === table); });
      document.getElementById("breadcrumb").innerHTML = `<strong>${escapeHtml(table)}</strong>`;
      document.getElementById("query-section").style.display = "block";
      document.getElementById("empty-state").style.display = "none";
      lastQuery = table === "llm_log"
        ? "SELECT * FROM llm_log ORDER BY created_at DESC LIMIT 200"
        : `SELECT * FROM ${table}`;
      document.getElementById("query-editor").value = lastQuery;

      const j = await api("GET", "/api/db/schema/" + encodeURIComponent(table));
      schema = { columns: j.columns || [], foreignKeys: j.foreignKeys || [] };
      await runCurrentQuery();
    }

    async function runCurrentQuery() {
      const sql = document.getElementById("query-editor").value.trim();
      if (!sql) return;
      lastQuery = sql;
      showMsg("query-msg", "");
      try {
        const j = await api("POST", "/api/db/query", { sql });
        if (j.error) { showMsg("query-msg", j.error, true); return; }
        if (j.columns && j.rows) {
          lastResult = { columns: j.columns, rows: j.rows };
          renderResult(j.columns, j.rows);
          showMsg("query-msg", `${j.rows.length} row(s)`);
        } else {
          lastResult = { columns: [], rows: [] };
          renderResult([], []);
          showMsg("query-msg", j.changes !== undefined ? `Done. Changes: ${j.changes}` : "Done.");
        }
      } catch (e) {
        showMsg("query-msg", e.message, true);
      }
    }

    function pkColumns() {
      return (schema.columns || []).filter(c => c.pk > 0).sort((a, b) => a.pk - b.pk).map(c => c.name);
    }

    function fkForColumn(col) {
      const explicit = schema.foreignKeys.find(fk => fk.from === col);
      if (explicit) return explicit;
      if (col.endsWith("_id")) {
        const stem = col.slice(0, -3);
        const refTable = tables.includes(stem + "s") ? stem + "s" : (tables.includes(stem) ? stem : null);
        if (refTable) return { table: refTable, from: col, to: "id" };
      }
      return null;
    }

    async function fetchUserLabels(columns, rows) {
      const userFkCols = columns.filter(c => { const fk = fkForColumn(c); return fk && fk.table === "users"; });
      if (userFkCols.length === 0) return {};
      const ids = new Set();
      rows.forEach(row => userFkCols.forEach(col => { const v = row[col]; if (v !== null && v !== undefined && v !== "") ids.add(Number(v)); }));
      if (ids.size === 0) return {};
      const j = await api("GET", "/api/db/users?ids=" + Array.from(ids).join(","));
      const users = j.users || [];
      const map = {};
      users.forEach(u => { const name = [u.first_name, u.last_name].map(s => (s || "").trim()).filter(Boolean).join(" ") || "(no name)"; map[u.id] = name; });
      return map;
    }

    function renderResult(columns, rows) {
      const thead = document.getElementById("result-thead");
      const tbody = document.getElementById("result-tbody");
      const tableEl = document.getElementById("result-table");
      const actionsEl = document.getElementById("table-actions");
      tableEl.style.display = "block";
      actionsEl.style.display = selectedTable ? "block" : "none";
      const pkCols = pkColumns();
      thead.innerHTML = "<tr>" + columns.map(c => `<th>${escapeHtml(c)}</th>`).join("") + "<th>Actions</th></tr>";
      if (rows.length === 0) {
        tbody.innerHTML = "<tr><td colspan='" + (columns.length + 1) + "' class='empty'>No rows</td></tr>";
        return;
      }
      function paintRows(userLabel) {
        tbody.innerHTML = rows.map((row, rowIndex) => {
          const cells = columns.map(col => {
            const val = row[col];
            const fk = fkForColumn(col);
            let display = val === null || val === undefined ? "" : String(val);
            const colLower = (col || "").toLowerCase();
            const tableLower = (selectedTable || "").toLowerCase();
            const isReminderTime = tableLower === "reminders" && (colLower === "fire_at_utc" || colLower === "next_fire_at_utc");
            if (isReminderTime && display) {
              display = formatUtcToEt(val);
            }
            const isLongText = tableLower === "llm_log" && (colLower === "request_doc" || colLower === "response_text");
            if (isLongText) {
              const truncated = display.length > 80 ? display.slice(0, 80) + "…" : display;
              return `<td class="text-cell" data-row-index="${rowIndex}" data-column="${escapeHtml(col)}" title="Click to view full content">${escapeHtml(truncated)}</td>`;
            }
            if (fk && fk.table === "users" && (display !== "" || val === 0)) {
              const name = userLabel[Number(val)] || "";
              display = name ? name + " (" + val + ")" : display;
            }
            if (fk && (display !== "" || val === 0)) {
              const rawVal = val === null || val === undefined ? "" : String(val);
              return `<td class="fk" data-fk-table="${escapeHtml(fk.table)}" data-fk-column="${escapeHtml(fk.to)}" data-fk-value="${escapeHtml(rawVal)}" title="View ${escapeHtml(fk.table)}.${escapeHtml(fk.to)} = ${escapeHtml(rawVal)}">${escapeHtml(display)}</td>`;
            }
            return `<td>${escapeHtml(display)}</td>`;
          });
          cells.push(`<td><button class="primary" data-row-index="${rowIndex}" data-action="edit">Edit</button> <button class="danger" data-row-index="${rowIndex}" data-action="delete">Delete</button></td>`);
          return "<tr>" + cells.join("") + "</tr>";
        }).join("");

        tbody.querySelectorAll("td.fk").forEach(td => {
          td.addEventListener("click", () => {
            const table = td.dataset.fkTable;
            const column = td.dataset.fkColumn;
            const value = td.dataset.fkValue;
            loadRowDetail(table, column, value);
          });
        });
        tbody.querySelectorAll("td.text-cell").forEach(td => {
          td.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (!lastResult || !lastResult.rows) return;
            const rowIndex = parseInt(td.dataset.rowIndex, 10);
            if (Number.isNaN(rowIndex) || rowIndex < 0 || rowIndex >= lastResult.rows.length) return;
            const col = td.getAttribute("data-column");
            const row = lastResult.rows[rowIndex];
            if (!row || col == null) return;
            const colKey = Object.keys(row).find((k) => k.toLowerCase() === col.toLowerCase()) || col;
            let full = row[colKey];
            full = full === null || full === undefined ? "" : String(full);
            if (colKey.toLowerCase() === "request_doc" && full) {
              try {
                const parsed = JSON.parse(full);
                full = JSON.stringify(parsed, null, 2);
              } catch (_) {}
            }
            full = prettifyForDisplay(full || "");
            document.getElementById("cell-content-title").textContent = col;
            document.getElementById("cell-content-body").textContent = full || "(empty)";
            document.getElementById("cell-content-modal").classList.add("visible");
          });
        });
        tbody.querySelectorAll("button[data-action=edit]").forEach(btn => {
          btn.addEventListener("click", () => openEditModal(parseInt(btn.dataset.rowIndex, 10)));
        });
        tbody.querySelectorAll("button[data-action=delete]").forEach(btn => {
          btn.addEventListener("click", () => deleteRow(parseInt(btn.dataset.rowIndex, 10)));
        });
      }

      fetchUserLabels(columns, rows).then(paintRows).catch(() => paintRows({}));
    }

    function openNewModal() {
      document.getElementById("row-modal-title").textContent = "New row – " + selectedTable;
      const fieldsEl = document.getElementById("row-modal-fields");
      fieldsEl.innerHTML = (schema.columns || []).map(c => {
        const val = c.dflt_value !== null && c.dflt_value !== undefined ? String(c.dflt_value).replace(/^'|'$/g, "") : "";
        return `<div class="form-row"><label>${escapeHtml(c.name)}</label><input name="${escapeHtml(c.name)}" value="${escapeHtml(val)}" /></div>`;
      }).join("");
      document.getElementById("row-modal").dataset.mode = "new";
      document.getElementById("row-modal").classList.add("visible");
    }

    function openEditModal(rowIndex) {
      const row = lastResult.rows[rowIndex];
      if (!row) return;
      document.getElementById("row-modal-title").textContent = "Edit row – " + selectedTable;
      const fieldsEl = document.getElementById("row-modal-fields");
      const pkCols = pkColumns();
      fieldsEl.innerHTML = (schema.columns || []).map(c => {
        const val = row[c.name];
        const v = val === null || val === undefined ? "" : String(val);
        const readOnly = pkCols.includes(c.name) ? " readonly" : "";
        return `<div class="form-row"><label>${escapeHtml(c.name)}</label><input name="${escapeHtml(c.name)}" value="${escapeHtml(v)}"${readOnly} /></div>`;
      }).join("");
      document.getElementById("row-modal").dataset.mode = "edit";
      document.getElementById("row-modal").dataset.rowIndex = String(rowIndex);
      document.getElementById("row-modal").classList.add("visible");
    }

    function closeRowModal() {
      document.getElementById("row-modal").classList.remove("visible");
    }

    async function saveRowModal() {
      const mode = document.getElementById("row-modal").dataset.mode;
      const fieldsEl = document.getElementById("row-modal-fields");
      const inputs = fieldsEl.querySelectorAll("input[name], textarea[name]");
      const data = {};
      inputs.forEach(inp => { data[inp.name] = inp.value === "" ? undefined : inp.value; });
      try {
        if (mode === "new") {
          await api("POST", "/api/db/row/" + encodeURIComponent(selectedTable), data);
          showMsg("query-msg", "Row created.");
        } else {
          const rowIndex = parseInt(document.getElementById("row-modal").dataset.rowIndex, 10);
          const row = lastResult.rows[rowIndex];
          const pkCols = pkColumns();
          const pk = pkCols.reduce((o, k) => { o[k] = row[k]; return o; }, {});
          await api("PATCH", "/api/db/row/" + encodeURIComponent(selectedTable), { pk, data });
          showMsg("query-msg", "Row updated.");
        }
        closeRowModal();
        runCurrentQuery();
      } catch (e) {
        showMsg("query-msg", e.message, true);
      }
    }

    async function deleteRow(rowIndex) {
      const row = lastResult.rows[rowIndex];
      if (!row || !confirm("Delete this row?")) return;
      const pkCols = pkColumns();
      const pk = pkCols.reduce((o, k) => { o[k] = row[k]; return o; }, {});
      try {
        await api("DELETE", "/api/db/row/" + encodeURIComponent(selectedTable), { pk });
        showMsg("query-msg", "Row deleted.");
        runCurrentQuery();
      } catch (e) {
        showMsg("query-msg", e.message, true);
      }
    }

    async function loadRowDetail(table, column, value) {
      const path = `/api/db/row/${encodeURIComponent(table)}/${encodeURIComponent(column)}/${encodeURIComponent(value)}`;
      const j = await api("GET", path);
      const panel = document.getElementById("row-detail");
      const titleEl = document.getElementById("row-detail-title");
      const bodyEl = document.getElementById("row-detail-body");
      if (!j.row) {
        titleEl.textContent = `${table}.${column} = ${value}`;
        bodyEl.textContent = "(no row found)";
      } else {
        titleEl.textContent = `${table} where ${column} = ${value}`;
        bodyEl.textContent = JSON.stringify(j.row, null, 2);
      }
      panel.style.display = "block";
    }

    document.getElementById("run-query").addEventListener("click", () => runCurrentQuery());

    document.getElementById("new-row-btn").addEventListener("click", () => openNewModal());
    document.getElementById("row-modal-save").addEventListener("click", () => saveRowModal());
    document.getElementById("row-modal-cancel").addEventListener("click", () => closeRowModal());
    document.getElementById("row-modal").addEventListener("click", (e) => { if (e.target.id === "row-modal") closeRowModal(); });

    document.getElementById("cell-content-close").addEventListener("click", () => document.getElementById("cell-content-modal").classList.remove("visible"));
    document.getElementById("cell-content-modal").addEventListener("click", (e) => { if (e.target.id === "cell-content-modal") e.target.classList.remove("visible"); });

    document.getElementById("reset-query").addEventListener("click", () => {
      if (selectedTable) {
        const defaultQuery = "SELECT * FROM " + selectedTable;
        document.getElementById("query-editor").value = defaultQuery;
        runCurrentQuery();
      }
    });

    loadTables();
  </script>
</body>
</html>
