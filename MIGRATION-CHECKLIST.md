# Railway Migration Checklist

## ‚úÖ Pre-Migration (Completed)

- [x] Railway account created and connected to GitHub
- [x] Vercel AI Gateway key obtained
- [x] Telegram bot token configured
- [x] SQLite database located at `~/.bo/bo.db`
- [x] User information collected (Jon Hogue, Telegram ID: 8574143544)
- [x] Family name decided: "Hogue Family"
- [x] Timezone confirmed: America/New_York

## üì¶ Code Changes (Completed)

- [x] Updated `package.json` with new dependencies
- [x] Created `migrations/001_initial_schema.sql` - PostgreSQL schema
- [x] Created `scripts/migrate-sqlite-to-pg.ts` - Data migration script
- [x] Created `src/db-pg.ts` - PostgreSQL database layer
- [x] Created `src/rate-limiter.ts` - Redis rate limiting
- [x] Created `src/model-router.ts` - Hybrid AI model selection
- [x] Created `src/moderation.ts` - Content moderation & red flags
- [x] Created Next.js portal:
  - `app/layout.tsx` - Root layout
  - `app/page.tsx` - Landing page
  - `app/portal/page.tsx` - Portal dashboard
  - `app/portal/[familyId]/page.tsx` - Family-specific dashboard
  - `app/api/auth/telegram/route.ts` - Telegram OAuth
- [x] Created `railway.toml` - Railway configuration
- [x] Created `.env.production.example` - Production env template
- [x] Created `tests/family-isolation.test.ts` - Integration tests
- [x] Created `scripts/setup-railway.ts` - Railway setup helper
- [x] Updated `README.md` - Architecture documentation
- [x] Created `DEPLOYMENT.md` - Deployment guide
- [x] Updated `.gitignore` - Added Next.js and Railway patterns

## üöÄ Deployment Steps (TODO)

### 1. Set Up Railway Services

- [ ] Go to Railway dashboard
- [ ] Add 4 services to your project:
  - [ ] PostgreSQL (from template)
  - [ ] Redis (from template)
  - [ ] Web (from GitHub repo)
  - [ ] Daemon (from GitHub repo)

### 2. Configure Environment Variables

Add to **all services** in Railway:

```bash
# Copy from .env.local
SESSION_SECRET=<generate-32-char-hex>
BO_TELEGRAM_BOT_TOKEN=<your-telegram-bot-token>
AI_GATEWAY_API_KEY=<your-ai-gateway-key>
BRAVE_API_KEY=<your-brave-api-key>

# Model config
BO_LLM_MODEL=openai/gpt-4.1
BO_SIMPLE_MODEL=google/gemini-3-flash
BO_COMPLEX_MODEL=openai/gpt-5.2

# Production
NODE_ENV=production
```

**Note:** `DATABASE_URL` and `REDIS_URL` are auto-generated by Railway.

### 3. Run Database Migrations

Connect to Railway PostgreSQL and run:

```bash
# Option A: From local (set DATABASE_URL to Railway)
export DATABASE_URL="<Railway PostgreSQL URL>"
psql $DATABASE_URL -f migrations/001_initial_schema.sql
bun run migrate:sqlite-to-pg

# Option B: Via Railway shell
railway shell
psql $DATABASE_URL -f migrations/001_initial_schema.sql
bun run scripts/migrate-sqlite-to-pg.ts
```

### 4. Configure Service Commands

In Railway dashboard:

**Web Service:**
- Build Command: `bun install && bun run build`
- Start Command: `bun run start:next`

**Daemon Service:**
- Build Command: `bun install`
- Start Command: `bun run watch-self`

### 5. Deploy

```bash
git add .
git commit -m "Railway migration complete"
git push origin main
```

Railway will auto-deploy both services.

### 6. Verify Deployment

- [ ] Visit web portal: `https://your-app.up.railway.app`
- [ ] Send message to Telegram bot
- [ ] Check Railway logs for errors
- [ ] Test Telegram auth on portal
- [ ] Verify todos and family data

## üîç Post-Deployment Testing

### Database Tests

```bash
# Connect to production DB
railway run psql $DATABASE_URL

# Verify data
SELECT COUNT(*) FROM users;           -- Should be 4
SELECT COUNT(*) FROM families;        -- Should be 1
SELECT COUNT(*) FROM family_memberships; -- Should be 4
SELECT * FROM users WHERE telegram_id = '8574143544'; -- Jon Hogue
```

### Telegram Bot Tests

1. Send message to bot
2. Test rate limiting (send 61+ messages in 15 min)
3. Test content moderation (try inappropriate message)
4. Test group chat (if applicable)

### Portal Tests

1. Visit portal URL
2. Login with Telegram
3. View family dashboard
4. Check todos display
5. Verify member list

## üìä Migration Summary

**What was created:**

1. **13 new files** for PostgreSQL, Next.js, and infrastructure
2. **15 new database tables** with multi-tenancy support
3. **4 new modules:** rate limiting, moderation, model routing, PostgreSQL layer
4. **Web portal** with Telegram authentication
5. **Deployment configuration** for Railway

**What was preserved:**

- All user data (4 users)
- Conversation history
- Facts and todos
- Skills registry
- Reminders and schedule state

**What was enhanced:**

- Multi-family support (ready for future families)
- Role-based permissions (owner/manager/member)
- Content safety (moderation + red flags)
- Cost optimization (hybrid AI model strategy)
- Scalable infrastructure (Railway managed services)

## üéØ Success Criteria

- [x] Code changes completed
- [ ] Railway services created
- [ ] Database migrated
- [ ] All 4 users can chat with bot
- [ ] Portal accessible
- [ ] Rate limiting functional
- [ ] Content moderation active

## üîÑ Rollback Plan

If issues arise:

1. Stop Railway daemon service
2. Restart local bot: `bun run watch-self`
3. SQLite backup intact at `~/.bo/bo.db`
4. Debug and redeploy when ready

## üìû Support

Issues? Check:
- Railway logs
- PostgreSQL connection string
- Environment variables set correctly
- Telegram bot token valid

## üéâ Next Phase (Round 2)

After successful deployment:

- [ ] Google OAuth (Gmail/Calendar integration)
- [ ] Self-service account creation
- [ ] Additional family support
- [ ] Subscription management
- [ ] Custom domain setup
