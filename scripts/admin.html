<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bo DB Admin</title>
  <style>
    :root { --bg: #1a1b1e; --card: #25262b; --border: #373a40; --text: #e8e8e8; --muted: #909296; --accent: #4dabf7; --danger: #ff6b6b; --fk: #69db7c; }
    * { box-sizing: border-box; }
    body { font-family: ui-monospace, "Cascadia Code", monospace; background: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.5; display: flex; min-height: 100vh; font-size: 13px; }
    h1 { font-size: 1rem; margin: 0 0 1rem; color: var(--accent); }
    .sidebar { width: 200px; min-width: 200px; background: var(--card); border-right: 1px solid var(--border); padding: 0.75rem; overflow-y: auto; }
    .sidebar-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 0.5rem; }
    .table-list { list-style: none; padding: 0; margin: 0; }
    .table-list li { margin: 0.125rem 0; }
    .table-list a { display: block; padding: 0.4rem 0.6rem; border-radius: 4px; color: var(--text); text-decoration: none; cursor: pointer; }
    .table-list a:hover { background: #2c2e33; }
    .table-list a.active { background: var(--accent); color: var(--bg); }
    .main { flex: 1; padding: 1rem; overflow: auto; min-width: 0; display: flex; flex-direction: column; }
    .query-section { margin-bottom: 1rem; }
    .query-editor { width: 100%; min-height: 80px; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.6rem; border-radius: 4px; font-family: inherit; font-size: 12px; resize: vertical; }
    .query-editor:focus { outline: none; border-color: var(--accent); }
    .query-actions { margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    button.primary { background: var(--accent); color: var(--bg); border: none; padding: 0.4rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 12px; }
    button.primary:hover { filter: brightness(1.1); }
    .msg { padding: 0.4rem 0.6rem; border-radius: 4px; font-size: 12px; }
    .msg.ok { background: rgba(77, 171, 247, 0.2); color: var(--accent); }
    .msg.err { background: rgba(255, 107, 107, 0.2); color: var(--danger); }
    .result-wrap { flex: 1; overflow: auto; }
    table.data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .data-table th, .data-table td { text-align: left; padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--border); white-space: pre-wrap; word-break: break-word; vertical-align: top; }
    .data-table th { color: var(--muted); font-weight: 500; position: sticky; top: 0; background: var(--card); }
    .data-table td.fk { color: var(--fk); cursor: pointer; text-decoration: underline; }
    .data-table td.fk:hover { filter: brightness(1.2); }
    .empty { color: var(--muted); font-style: italic; }
    .row-detail { margin-top: 1rem; padding: 1rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; }
    .row-detail h3 { font-size: 0.9rem; margin: 0 0 0.5rem; color: var(--muted); }
    .row-detail pre { margin: 0; font-size: 11px; white-space: pre-wrap; word-break: break-all; }
    .breadcrumb { font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem; }
    .breadcrumb strong { color: var(--text); }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>Bo DB</h1>
    <div class="sidebar-title">Tables</div>
    <ul class="table-list" id="table-list"></ul>
  </aside>
  <main class="main">
    <div id="breadcrumb" class="breadcrumb"></div>
    <div id="query-section" class="query-section" style="display:none;">
      <textarea id="query-editor" class="query-editor" placeholder="SELECT * FROM ..."></textarea>
      <div class="query-actions">
        <button class="primary" id="run-query">Run</button>
        <span id="query-msg"></span>
      </div>
    </div>
    <div class="result-wrap">
      <table class="data-table" id="result-table" style="display:none;">
        <thead id="result-thead"></thead>
        <tbody id="result-tbody"></tbody>
      </table>
      <div id="empty-state" class="empty" style="padding: 2rem;">Select a table or run a query.</div>
    </div>
    <div id="row-detail" class="row-detail" style="display:none;">
      <h3 id="row-detail-title"></h3>
      <pre id="row-detail-body"></pre>
    </div>
  </main>

  <script>
    const API = "";
    function escapeHtml(s) { const d = document.createElement("div"); d.textContent = s ?? ""; return d.innerHTML; }

    async function api(method, path, body) {
      const opt = { method, headers: body ? { "Content-Type": "application/json" } : {} };
      if (body) opt.body = JSON.stringify(body);
      const r = await fetch(API + path, opt);
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || r.statusText);
      return j;
    }

    function showMsg(elId, text, isErr) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.textContent = text || "";
      el.className = "msg " + (text ? (isErr ? "err" : "ok") : "");
    }

    let tables = [];
    let selectedTable = null;
    let schema = { columns: [], foreignKeys: [] };
    let lastQuery = "";
    let lastResult = { columns: [], rows: [] };

    async function loadTables() {
      const ul = document.getElementById("table-list");
      ul.innerHTML = "<li class='empty'>Loadingâ€¦</li>";
      try {
        const j = await api("GET", "/api/db/tables");
        tables = Array.isArray(j.tables) ? j.tables : [];
        if (tables.length === 0) {
          ul.innerHTML = "<li class='empty'>No tables</li>";
          return;
        }
        ul.innerHTML = tables.map(t => `<li><a href="#" data-table="${escapeHtml(t)}">${escapeHtml(t)}</a></li>`).join("");
        ul.querySelectorAll("a").forEach(a => {
          a.addEventListener("click", (e) => { e.preventDefault(); selectTable(a.dataset.table); });
        });
      } catch (e) {
        ul.innerHTML = "<li class='empty' style='color:var(--danger)'>Error: " + escapeHtml(e.message) + ". Open this page at http://localhost:" + (location.port || "3847") + "</li>";
      }
    }

    async function selectTable(table) {
      selectedTable = table;
      document.querySelectorAll(".table-list a").forEach(a => { a.classList.toggle("active", a.dataset.table === table); });
      document.getElementById("breadcrumb").innerHTML = `<strong>${escapeHtml(table)}</strong>`;
      document.getElementById("query-section").style.display = "block";
      document.getElementById("empty-state").style.display = "none";
      lastQuery = `SELECT * FROM ${table}`;
      document.getElementById("query-editor").value = lastQuery;

      const j = await api("GET", "/api/db/schema/" + encodeURIComponent(table));
      schema = { columns: j.columns || [], foreignKeys: j.foreignKeys || [] };
      await runCurrentQuery();
    }

    async function runCurrentQuery() {
      const sql = document.getElementById("query-editor").value.trim();
      if (!sql) return;
      lastQuery = sql;
      showMsg("query-msg", "");
      try {
        const j = await api("POST", "/api/db/query", { sql });
        if (j.error) { showMsg("query-msg", j.error, true); return; }
        if (j.columns && j.rows) {
          lastResult = { columns: j.columns, rows: j.rows };
          renderResult(j.columns, j.rows);
          showMsg("query-msg", `${j.rows.length} row(s)`);
        } else {
          lastResult = { columns: [], rows: [] };
          renderResult([], []);
          showMsg("query-msg", j.changes !== undefined ? `Done. Changes: ${j.changes}` : "Done.");
        }
      } catch (e) {
        showMsg("query-msg", e.message, true);
      }
    }

    function fkForColumn(col) {
      const explicit = schema.foreignKeys.find(fk => fk.from === col);
      if (explicit) return explicit;
      if (col.endsWith("_id")) {
        const stem = col.slice(0, -3);
        const refTable = tables.includes(stem + "s") ? stem + "s" : (tables.includes(stem) ? stem : null);
        if (refTable) return { table: refTable, from: col, to: "id" };
      }
      return null;
    }

    function renderResult(columns, rows) {
      const thead = document.getElementById("result-thead");
      const tbody = document.getElementById("result-tbody");
      const tableEl = document.getElementById("result-table");
      tableEl.style.display = "block";
      thead.innerHTML = "<tr>" + columns.map(c => `<th>${escapeHtml(c)}</th>`).join("") + "</tr>";
      if (rows.length === 0) {
        tbody.innerHTML = "<tr><td colspan='" + columns.length + "' class='empty'>No rows</td></tr>";
        return;
      }
      tbody.innerHTML = rows.map(row => {
        return "<tr>" + columns.map(col => {
          const val = row[col];
          const fk = fkForColumn(col);
          const display = val === null || val === undefined ? "" : String(val);
          if (fk && (display !== "" || val === 0)) {
            return `<td class="fk" data-fk-table="${escapeHtml(fk.table)}" data-fk-column="${escapeHtml(fk.to)}" data-fk-value="${escapeHtml(display)}" title="View ${escapeHtml(fk.table)}.${escapeHtml(fk.to)} = ${escapeHtml(display)}">${escapeHtml(display)}</td>`;
          }
          return `<td>${escapeHtml(display)}</td>`;
        }).join("") + "</tr>";
      }).join("");

      tbody.querySelectorAll("td.fk").forEach(td => {
        td.addEventListener("click", () => {
          const table = td.dataset.fkTable;
          const column = td.dataset.fkColumn;
          const value = td.dataset.fkValue;
          loadRowDetail(table, column, value);
        });
      });
    }

    async function loadRowDetail(table, column, value) {
      const path = `/api/db/row/${encodeURIComponent(table)}/${encodeURIComponent(column)}/${encodeURIComponent(value)}`;
      const j = await api("GET", path);
      const panel = document.getElementById("row-detail");
      const titleEl = document.getElementById("row-detail-title");
      const bodyEl = document.getElementById("row-detail-body");
      if (!j.row) {
        titleEl.textContent = `${table}.${column} = ${value}`;
        bodyEl.textContent = "(no row found)";
      } else {
        titleEl.textContent = `${table} where ${column} = ${value}`;
        bodyEl.textContent = JSON.stringify(j.row, null, 2);
      }
      panel.style.display = "block";
    }

    document.getElementById("run-query").addEventListener("click", () => runCurrentQuery());

    loadTables();
  </script>
</body>
</html>
