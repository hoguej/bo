# Bo Deployment Guide - Railway

This guide walks you through deploying Bo to Railway with PostgreSQL and Redis.

## Prerequisites

- Railway account with GitHub connected
- Railway API token (in `.env.local` as `RAILWAY_KEY`)
- Vercel AI Gateway key
- Telegram bot token

## Step 1: Set Up Railway Project

Your Railway project should have **4 services**:

1. **PostgreSQL** - Database
2. **Redis** - Rate limiting
3. **Next.js App** - Web portal
4. **Bo Daemon** - Telegram bot (persistent process)

### Create Services via Railway Dashboard:

1. Go to https://railway.app/dashboard
2. Select your project
3. Click "New Service"
4. Add PostgreSQL (from template)
5. Add Redis (from template)
6. Add "GitHub Repo" twice (for Next.js and Daemon)

### Or Create via Railway CLI:

```bash
# Install Railway CLI
npm i -g @railway/cli

# Login
railway login

# Link to project
railway link

# Add services
railway service create --name postgres --template postgresql
railway service create --name redis --template redis
railway service create --name web --source .
railway service create --name daemon --source .
```

## Step 2: Configure Environment Variables

Add these to **all services** in Railway:

```bash
# Auto-generated by Railway (don't set manually)
DATABASE_URL=postgresql://...
REDIS_URL=redis://...

# Your secrets (add to Railway dashboard)
SESSION_SECRET=<generate-32-char-hex>
BO_TELEGRAM_BOT_TOKEN=<your-telegram-bot-token>
AI_GATEWAY_API_KEY=<your-ai-gateway-key>
BRAVE_API_KEY=<your-brave-api-key>

# Model configuration
BO_LLM_MODEL=openai/gpt-4.1
BO_SIMPLE_MODEL=google/gemini-3-flash
BO_COMPLEX_MODEL=openai/gpt-5.2

# Production
NODE_ENV=production
```

## Step 3: Run Database Migration

### Option A: From Local Machine

```bash
# Set DATABASE_URL to Railway PostgreSQL
export DATABASE_URL="postgresql://user:pass@region.railway.app:5432/railway"

# Run schema migration
psql $DATABASE_URL -f migrations/001_initial_schema.sql

# Run data migration
bun run migrate:sqlite-to-pg
```

### Option B: From Railway Shell

```bash
# In Railway dashboard, open shell for "web" service
railway shell

# Run migrations
psql $DATABASE_URL -f migrations/001_initial_schema.sql
bun run scripts/migrate-sqlite-to-pg.ts
```

## Step 4: Configure Service Start Commands

In Railway dashboard, set start commands for each service:

**Web Service (Next.js):**
```bash
bun run build && bun run start:next
```

**Daemon Service (Bo Bot):**
```bash
bun run src/commands/watch-self.ts
```

## Step 5: Deploy

```bash
# Commit changes
git add .
git commit -m "Add Railway deployment configuration"
git push origin main

# Railway deploys from `prod` branch (explicit deploys; see docs/deploy-from-prod-branch.md)
# Monitor deployment in Railway dashboard
```

## Step 6: Verify Deployment

1. **Check PostgreSQL:**
   ```bash
   railway run psql $DATABASE_URL -c "SELECT COUNT(*) FROM users;"
   ```

2. **Check Redis:**
   ```bash
   railway run redis-cli -u $REDIS_URL PING
   ```

3. **Check Web App:**
   - Visit: `https://your-app.up.railway.app`
   - Should see Bo landing page

4. **Check Daemon:**
   - Send message to Telegram bot
   - Should receive response

## Step 7: Monitor

- **Railway Dashboard:** Check logs, metrics, and health
- **Telegram Bot:** Test with `/start` command
- **Portal:** Login via Telegram auth
- **Database:** Verify data integrity

## Rollback Plan

If anything goes wrong:

1. **Stop Railway services** (don't delete them yet)
2. **Restart local daemon:**
   ```bash
   bun run watch-self
   ```
3. **Check SQLite backup** at `~/.bo/bo.db.backup`
4. **Debug issues** in Railway logs
5. **Re-deploy** once fixed

## Troubleshooting

### Database Connection Issues

```bash
# Test connection
railway run psql $DATABASE_URL -c "SELECT 1;"
```

### Redis Connection Issues

```bash
# Test connection
railway run redis-cli -u $REDIS_URL PING
```

### Daemon Not Starting

- Check Railway logs for errors
- Verify `BO_TELEGRAM_BOT_TOKEN` is set
- Check `DATABASE_URL` and `REDIS_URL` are available

### Web App Not Loading

- Check build logs in Railway
- Verify Next.js dependencies installed
- Check `SESSION_SECRET` is set

## Cost Monitoring

Monthly costs (estimated):
- PostgreSQL: $5-10
- Redis: $5
- Web + Daemon: $10-15
- **Total: ~$20-30/month**

Monitor usage in Railway dashboard and adjust plans as needed.

## Next Steps

After successful deployment:

1. Test all features end-to-end
2. Invite family members to Telegram group
3. Configure custom domain (optional)
4. Set up monitoring (Sentry)
5. Plan Round 2 features (Google OAuth, etc.)
